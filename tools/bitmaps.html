<!DOCTYPE html>
<html lang="es">
  <head>
    <title>Bitmaps Tool</title>
    <style type="text/css">
      .table {
        display: table;
        border: 1px solid black;
      }
      
      .table > .tr {
        display: table-row;
      }
      
      .table > .tr > .td {
        display: table-cell;
        width: 10px;
        height: 10px;
        background: white;
        border: 1px solid black;
      }
      
      .table > .tr > .td:hover {
        border: 1px solid red;
      }
      
      .advanced {
        display: none;
      }
      
      .animation-controls {
        display: none;
      }
      
      button {
        vertical-align: top;
      }
      
      input[type=text], input[type=number] {
        vertical-align: top;
        width: 50px;
      }
      
      textarea {
        width: 1000px;
        height: 150px;
      }

      p {
        overflow: scroll;
      }
    </style>
  </head>
  <body>
    <table>
      <tr>
        <td>
          <div>
            <input id="name" type="text" value="bitmap" style="width:150px;" />
            <input id="cols" type="number" value="8" step="8" min="8" />
            <input id="rows" type="number" value="8" step="8" min="8" />
            <button id="drawButton" onmousedown="newTable();">New</button>
            <textarea id="bitmap-to-import" class="advanced" style="width:340px;height:15px;"></textarea>
            <button class="advanced" onmousedown="newTableFromJSON();">New From JSON</button>
          </div>
          <div class="advanced">
            <button onmousedown="exportBitmaps();">Export All</button>
            <textarea id="bitmaps-to-import" style="width:600px;height:15px;"></textarea>
            <button onmousedown="importBitmaps();">Import Several</button>
            <div id="bitmaps"></div>
          </div>
          <br />
          <div id="canvas" style="max-height: 800px; min-width: 800px; overflow: auto;"></div>
        </td>
        <td style="vertical-align:top;">
          <input id="toggle-advanced-options" type="checkbox" onclick="toggleAdvancedOptions();" /><label>Show Advanced Options</label>
          <div class="animation-controls advanced">
            <label>Velocidad de la Animación:</label> <input id="speed" type="number" value="1000" step="100" min="10" onchange="previewAnimation();" />
            <div class="displayer"></div>
          </div>
        </td>
      </tr>
    </table>

<script type="text/javascript">
  const canvas = document.getElementById( 'canvas' ); // Contenedor de las Tablas
  const animationControls = document.querySelector( '.animation-controls' );
  const animationDisplayer = animationControls.querySelector( '.displayer' ); // Contenedor de la Animación
  const toggleAdvancedOptionsChk = document.getElementById( 'toggle-advanced-options' );
  let advancedObjs = document.querySelectorAll( '.advanced' ); // Funcionalidades Avanzadas
  let theAnimation,
      tbls,
      lastTableId = 0,
      currentTable = 0,
      tables = [],
      bitmaps = [],
      autoToggleColor = false;
  
// Función para la Animación
function previewAnimation() {
  tbls = document.querySelectorAll( '#canvas .table' );
  clearInterval( theAnimation );
  if ( ( tbls.length > 1 ) && toggleAdvancedOptionsChk.checked ) {
    const speed = document.getElementById( 'speed' ).value;
    animationControls.classList.remove( 'animation-controls' );
    theAnimation = setInterval( function() {
      currentTable = ( currentTable >= ( tbls.length - 1 ) ) ? 0 : ( currentTable + 1 );
      //console.log( 'Hola ' + currentTable );
      animationDisplayer.innerHTML = tbls[ currentTable ].outerHTML;
    }, speed );
  } else {
    animationControls.classList.add( 'animation-controls' );
  }
}

// Función Llamada cuando se da Click en una Celda
function toggleColor( obj, tableId, currentPosX, currentPosY ) {
  if ( obj.style.background == 'black' ) {
    obj.style.background = 'white';
    bitmaps[ tableId ][ currentPosX ][ currentPosY ] = 0;
  } else {
    obj.style.background = 'black';
    bitmaps[ tableId ][ currentPosX ][ currentPosY ] = 1;
  }
	if ( canvas.querySelector( '#table'+tableId+' > .actions > .auto-bitmap' ).checked ) { printBitmap( tableId ); };
}

// Función para crear y agregar una Tabla y su Bitmap
function createTable2( name, rows, cols ) {
  let tableId = lastTableId; //( ( tbls === undefined ) ? 0 : tbls.length );
  let container = '<div id="table'+tableId+'">';
  let currentPosX = 3;
  let currentPosY = 0;
  const isClonning = Array.isArray( name );
  
  if ( isClonning ) {
    bitmaps[ tableId ] = name;
    name = bitmaps[ tableId ][ 0 ];
    rows = bitmaps[ tableId ][ 1 ];
    cols = bitmaps[ tableId ][ 2 ];
  } else {
    bitmaps[ tableId ] = [ name, rows, cols, [] ];
  }
  
  container += '<div class="table" onmousedown="autoToggleColor=true;" onmouseup="autoToggleColor=false;" onmouseleave="autoToggleColor=false;">';
  
  for( let i = 0; i < rows; i++ ) {
    container += '<div class="tr">';
    for( let j = 0; j < cols; j++ ) {
      if ( !isClonning ) { bitmaps[ tableId ][ currentPosX ][ currentPosY ] = 0; }
      let style = ( ( bitmaps[ tableId ][ currentPosX ][ currentPosY ] == 1 ) ? ' style="background:black;"' : '' );
      container += '<div class="td"'+style+' onmousedown="toggleColor(this,'+tableId+','+currentPosX+','+currentPosY+');" onmouseover="if(autoToggleColor){toggleColor(this,'+tableId+','+currentPosX+','+currentPosY+');}"></div>';
      currentPosY += 1;
      if ( currentPosY >= 8 ) {
        currentPosX += 1;
        currentPosY = 0;
        if ( !isClonning ) { bitmaps[ tableId ][ currentPosX ] = []; }
      }
    }
    container += '</div>';
  }

  container += '</div>'; // Fin de la Tabla
  const advancedClass = ( ( toggleAdvancedOptionsChk.checked ) ? '' : ' advanced' );
  container += '<div class="actions'+advancedClass+'">';
  container += '<input type="checkbox" checked="checked" class="auto-bitmap" /><label>Auto</label> <button onmousedown="printBitmap('+tableId+');">Bitmap</button> <button onmousedown="printJSON('+tableId+');">JSON</button> <button onmousedown="cloneTable('+tableId+')">Clone</button> <button onmousedown="invertTable('+tableId+');">Invert</button> <button onmousedown="if(confirm(\'Esta seguro ?\')){deleteTable('+tableId+');}">Delete</button>';
  container += '</div><div class="bitmap"></div>';
  container += '<div class="json'+advancedClass+'"></div>';
  container += '</div>';
  canvas.innerHTML += container;
  
  previewAnimation();
  advancedObjs = document.querySelectorAll( '.advanced' );
  lastTableId += 1;
  
  return( tableId );
}

function newTable() {
  const name = document.getElementById( 'name' ).value;
  const rows = document.getElementById( 'rows' ).value;
  const cols = document.getElementById( 'cols' ).value;
  //createTable( rows, cols, name );
  createTable2( name, rows, cols );
}

function newTableFromJSON() {
  const json = document.getElementById( 'bitmap-to-import' ).value;
  createTable2( JSON.parse( json ) );
}

function cloneTable( tableId ) {
  createTable2( bitmaps[ tableId ] );
}

function invertTable( tableId ) {
  alert( 'Invertir los colores de la tabla : ' + tableId );
}

function printBitmap( tableId ) {
	let output = 'const uint8_t '+bitmaps[tableId][0]+'[] PROGMEM = { '+bitmaps[tableId][1]+','+bitmaps[tableId][2];
	let size = ( bitmaps[tableId].length - 2 );
	for ( let i = 3; i <=size; i++ ) {
    output += ',B'+bitmaps[tableId][i].join('');
	}
	output += ',};'
	canvas.querySelector( '#table'+tableId+' > .bitmap' ).innerHTML = output;
}

function printJSON( tableId ) {
  canvas.querySelector( '#table'+tableId+' > .json' ).innerHTML = JSON.stringify( bitmaps[ tableId ] );
}

function deleteTable( tableId ) {
  document.getElementById( 'table'+tableId ).remove();
  bitmaps[ tableId ] = undefined;
  previewAnimation();
}

function exportBitmaps() {
  document.getElementById( 'bitmaps' ).innerHTML = JSON.stringify( bitmaps );
}

function importBitmaps() {
  const json = document.getElementById( 'bitmaps-to-import' ).value;
  const bitmapsToImport = JSON.parse( json );
  bitmapsToImport.forEach( function( element ) {
    if ( Array.isArray( element ) ) { createTable2( element ); }
  } );
}

function toggleAdvancedOptions() {
  if ( toggleAdvancedOptionsChk.checked ) {
    advancedObjs.forEach( function( element ) {
      element.classList.remove( 'advanced' );
      previewAnimation();
    } );
  } else {
    const autoBitmaps = document.querySelectorAll( '.auto-bitmap' );
    
    advancedObjs.forEach( function( element ) {
      element.classList.add( 'advanced' );
      clearInterval( theAnimation );
    } );
    
    autoBitmaps.forEach( function( element ) {
      element.checked = true;
    } );
  }
}

// Codigo Viejo
function changeColor(obj, index){
	var color = 'black';
	if(obj.style.background == color){
		 color = 'white';
	}
	obj.style.background = color;
	exportBitmap(index);
}

// Codigo Viejo
function exportBitmap(index){	
	opts= tables[index];
	rows = document.getElementById(opts.tableId).rows;	
	output = document.getElementById(opts.outputId);	
	aux = 0;
	o = '';
	outputText = "const uint8_t "+opts.name+"[] PROGMEM = { "+opts.cols+","+ opts.rows+",";			
	for (var i = 0; i < rows.length; i++) {
		cells = rows[i].cells;
		for (var j = 0; j < cells.length; j++){										
				o += cells[j].style.background == 'black' ? '1' : '0';				
				aux+=1; 				
			if(aux == 8 ){			
				aux = 0;
				outputText += "B"+o+",";
				o = '';
			}		   
		}
	}
	outputText += "};";
	output.innerHTML = outputText;	
}

// Codigo Viejo
function createTable(rows, cols, name){
	var container  = document.createElement('div');
	var containerId = 'container_'+tables.length;
    container.setAttribute('id', containerId);

    var table  = document.createElement('table');
    var tableId = 'table_'+tables.length;
    table.setAttribute('id', tableId);
    table.setAttribute('class', 'table');
    

    var output  = document.createElement('p');
    var outputId = 'output_'+tables.length;
    output.setAttribute('id', outputId);

    
    var opts = {'tableId' : tableId, 'outputId': outputId,  'name': name, 'rows': rows, 'cols': cols };    
   
    var i = 0;
    var j = 0;    
    table.style.border = '1px solid black';
    for( i = 0; i < rows; i++){
        var tr = table.insertRow();
        for(j = 0; j < cols; j++){
                var td = tr.insertCell();
                td.style.border = '1px solid black';
                td.style.height = '10px';
                td.style.width = '10px';
                td.style.background = 'white';
                td.setAttribute("onmousedown","changeColor(this,"+tables.length+")");
                td.setAttribute("onmouseover","cellMouse(this, 'red')");
                td.setAttribute("onmouseout","cellMouse(this,'black')");                
        }
    }   
    
    container.appendChild(output);
    container.appendChild(table);
    canvas.appendChild(container);
    tables.push(opts);

    return table; 
}

// Codigo Viejo
function cellMouse(obj, color){
	obj.style.border = '1px solid '+ color; 
}

</script>

  </body>
</html>
